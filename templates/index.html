{% extends "base.html" %}
{% block content %}
<style>
    .swiper-pagination {
        position: absolute;
        bottom: 10px;
        text-align: center;
    }

    .swiper-pagination-bullet {
        background-color: #ffffffea;
        width: 6px;
        height: 6px;
        border-radius: 100%;
    }

    .swiper-pagination-bullet-active {
        background-color: #ecf2f7;
    }

    .swiper-button-next-notification,
    .swiper-button-prev-notification {
        width: 40px;
        height: 40px;
        background-color: rgba(43, 29, 29, 0.781);
        border-radius: 50%;
        color: #a5a2a2;
        transition: all 0.3s ease;
    }

    .swiper-button-next-notification:hover,
    .swiper-button-prev-notification:hover {
        background-color: rgba(0, 0, 0, 0.8);
        color: #FFFFFF;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }

    .swiper-button-next-notification:after,
    .swiper-button-prev-notification:after {
        font-size: 1.2rem;
        font-weight: bold;
    }

    @keyframes dots {

        0%,
        20% {
            content: '.';
        }

        40% {
            content: '..';
        }

        60%,
        100% {
            content: '...';
        }
    }

    .loading-dots::after {
        content: '';
        animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes reverse-spin {
        0% {
            transform: rotate(360deg);
        }

        100% {
            transform: rotate(0deg);
        }
    }

    .animate-reverse-spin {
        animation: reverse-spin 1s linear infinite;
    }
</style>
<div class="relative w-full overflow-hidden bg-black">
    <div class="swiper-container">
        <div class="swiper-wrapper">
            {% for top in topAiring %}
            <div class="swiper-slide">
                <div class="relative w-full h-[400px] md:h-[450px] lg:h-[500px] group">
                    <!-- Image -->
                    <img src="{{ top.banner }}" alt="{{ top.english }}"
                        class="absolute inset-0 w-full h-full object-cover object-center">

                    <!-- Gradient Overlay - Multiple layers for better effect -->
                    <div class="absolute inset-0 bg-gradient-to-r from-[#1a1625]/95 via-[#1a1625]/60 to-transparent">
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
                    <div class="absolute inset-0 bg-gradient-to-l from-[#1a1625]/70 via-transparent to-transparent">
                    </div>

                    <!-- Content -->
                    <div class="absolute inset-0 flex flex-col justify-end p-4 sm:p-6 lg:p-8">
                        <!-- Spotlight Badge -->
                        <div class="flex items-center space-x-2 mb-2 sm:mb-4">
                            <span
                                class="bg-purple-500/20 text-purple-200 border border-purple-400 px-2 py-0.5 sm:px-3 sm:py-1 rounded-md text-xs sm:text-sm">
                                #{{ loop.index }} Spotlight
                            </span>
                        </div>

                        <!-- Title -->
                        <h2
                            class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-1 sm:mb-2 line-clamp-2">
                            {{ top.english }}
                        </h2>

                        <!-- Metadata Row -->
                        <div
                            class="flex flex-wrap items-center gap-2 sm:gap-3 mt-2 sm:mt-4 mb-2 sm:mb-3 text-xs sm:text-sm text-gray-300">
                            <div class="flex items-center">
                                <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                    </path>
                                </svg>
                                <span>{{top.type}}</span>
                            </div>
                            <div class="w-1 h-1 rounded-full bg-gray-500 hidden sm:block"></div>
                            <span>{{top.duration}}m</span>
                            <div class="w-1 h-1 rounded-full bg-gray-500 hidden sm:block"></div>
                            <span>{{top.startDate}}</span>
                            <div class="w-1 h-1 rounded-full bg-gray-500 hidden sm:block"></div>
                            <span
                                class="bg-red-500/20 text-white border border-red-500 px-1.5 py-0.5 rounded-md text-xs">
                                HD
                            </span>
                            <div class="flex items-center space-x-1 sm:space-x-2">
                                <span
                                    class="bg-green-500/20 text-white border border-green-500 px-1.5 py-0.5 rounded-md text-xs">
                                    {{top.malScore}}
                                </span>
                                <span
                                    class="bg-gray-500/20 text-white border border-gray-500 px-1.5 py-0.5 rounded-md text-xs">
                                    {{top.ageRating}}
                                </span>
                            </div>
                        </div>
                        {% set clean_description = top.description|striptags %}

                        <!-- Description -->
                        <p
                            class="text-gray-300 mb-3 sm:mb-6 max-w-2xl text-xs sm:text-sm md:text-base line-clamp-2 sm:line-clamp-3">
                            {{clean_description}}
                        </p>

                        <!-- Buttons -->
                        <div class="flex flex-wrap gap-2 sm:gap-4">
                            <a href="/watch/{{ top.id }}"
                                class="bg-red-600 hover:bg-red-700 text-white rounded-full px-4 sm:px-6 py-1.5 sm:py-2 flex items-center text-xs sm:text-sm">
                                <i data-lucide="play" class="w-4 h-4 mr-3"></i>
                                WATCH NOW
                            </a>
                            <a href="/anime/{{ top.id }}"
                                class="text-white border border-white/30 bg-white/10 hover:bg-white/20 rounded-full px-4 sm:px-6 py-1.5 sm:py-2 flex items-center text-xs sm:text-sm">
                                <i data-lucide="info" class="w-5 h-5 mr-3"></i>
                                DETAILS
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="absolute top-4 right-4 flex gap-2 z-10">
        <button class="p-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded text-white transition-colors prev">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>
        <button class="p-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded text-white transition-colors next">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
    </div>

    <!-- Pagination Dots -->
    <div class="swiper-pagination hidden md:inline-block"></div>
</div>
{% if Surl %}
<div class="w-full flex flex-col items-center justify-center">
    <div id="counter" class="text-center py-6">
        <p class="text-md">Please wait <span id="countdown" class="text-red-600">0</span> Seconds...</p>
    </div>
    <div id="go-down" class="text-center py-6" style="display: none;">
        <p class="text-md">Click on <span class="text-red-600">Verify</span> Button to continue.</p>
        <button id="verify-button" class="px-6 py-2 mt-4 bg-red-600 rounded-full">Verify</button>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var countdownElement = document.getElementById('countdown');
        var goDownElement = document.getElementById('go-down');
        var counterElement = document.getElementById('counter');
        var verifyButton = document.getElementById('verify-button');
        var redirectButton = document.getElementById('redirect-button');
        var countdown = 15;

        redirectButton.style.display = 'none'; // Hide the redirect button initially

        var interval = setInterval(function () {
            countdown--;
            countdownElement.textContent = countdown;

            if (countdown <= 0) {
                clearInterval(interval);
                counterElement.style.display = 'none';
                goDownElement.style.display = 'block';
            }
        }, 1000);

        verifyButton.addEventListener('click', function () {
            goDownElement.style.display = 'none';
            redirectButton.style.display = 'block'; // Show the redirect button when verify button is clicked
            redirectButton.disabled = true; // Disable the redirect button initially
            redirectButton.style.opacity = 0.5;
            var redirectCountdown = 5;
            redirectButton.textContent = `Open Link (${redirectCountdown}s)`;

            var redirectInterval = setInterval(function () {
                redirectCountdown--;
                redirectButton.textContent = `Open Link (${redirectCountdown}s)`;

                if (redirectCountdown <= 0) {
                    clearInterval(redirectInterval);
                    redirectButton.disabled = false; // Enable the redirect button after 5 seconds
                    redirectButton.style.opacity = 1;
                    redirectButton.textContent = 'Open Link';
                }
            }, 1000);

            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        });
    });
</script>
{% endif %}

<main class="px-4 sm:px-6 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Main content area (left side) -->
        <div class="lg:col-span-8 xl:col-span-9">
            <!-- Your existing main content here -->
            <section class="mt-5 mb-16">
                {% if userInfo and ctotal %}
                <section class="mt-5 mb-16" x-data="{ 
                    animes: [],
                    loading: true,
                    async fetchAnimes() {
                        this.loading = true;
                        try {
                            const response = await fetch('/api/continue-watching-home');
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            this.animes = await response.json();
                        } catch (error) {
                            console.error('Error fetching animes:', error);
                            this.animes = [];
                        } finally {
                            this.loading = false;
                        }
                    }
                }" x-init="fetchAnimes">
                    <div class="mb-6 flex items-center justify-between">
                        <h2 class="text-xl sm:text-2xl font-semibold">Continue Watching</h2>
                        <a href="/user/continue-watching" class="text-sm text-gray-400 hover:text-white">View more →</a>
                    </div>

                    <div x-show="loading" class="flex justify-center items-center h-64">
                        <div class="text-2xl font-bold loading-dots" role="status">
                            Loading<span class="sr-only">Loading...</span>
                        </div>
                    </div>

                    <div x-show="!loading" class="swiper anime_watchlist_swiper_7391">
                        <div class="swiper-wrapper">
                            <template x-for="anime in animes" :key="anime.title">
                                <a x-bind:href="anime.link" class="swiper-slide">
                                    <div class="relative group cursor-pointer" @mouseenter="anime.hover = true"
                                        @mouseleave="anime.hover = false">
                                        <div class="relative overflow-hidden rounded-md">
                                            <img :src="anime.thumbnail"
                                                class="w-full aspect-video object-cover rounded-md transform transition-transform duration-300 group-hover:scale-105"
                                                :alt="anime.title">

                                            <!-- Play Button -->
                                            <div
                                                class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 transition-opacity duration-300 group-hover:opacity-100">
                                                <button class="bg-white p-2 rounded-full shadow-md hover:bg-gray-100">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800"
                                                        fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M8 5v14l11-7z" />
                                                    </svg>
                                                </button>
                                            </div>

                                            <!-- Delete Icon -->
                                            <button
                                                class="absolute top-2 right-2 bg-black/70 hover:text-white p-2 rounded-md opacity-0 transition-opacity duration-300 group-hover:opacity-100 hover:bg-black">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                    class="h-4 w-4 text-black hover:text-white" fill="none"
                                                    viewBox="0 0 24 24" stroke="white" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>

                                            <div class="absolute top-2 left-2 bg-black/70 px-2 py-1 rounded text-sm">
                                                EP <span x-text="anime.episode"></span>
                                            </div>
                                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-gray-600">
                                                <div class="h-full bg-red-600"
                                                    :style="`width: ${(parseInt(anime.progress) / parseInt(anime.duration)) * 100}%`">
                                                </div>
                                            </div>
                                            <div class="absolute bottom-2 right-2 bg-black/70 px-2 py-1 rounded text-sm">
                                                <span x-text="anime.progress"></span>/<span x-text="anime.duration"></span>
                                            </div>
                                        </div>
                                        <h3 class="mt-2 text-sm font-medium truncate" x-text="anime.title"></h3>
                                    </div>
                                </a>
                            </template>
                        </div>
                    </div>
                </section>
                {% endif %}
                <section class="mt-5">
                    <div class="mb-8 flex items-center justify-between">
                        <h2 class="text-xl sm:text-2xl font-bold text-white relative inline-flex items-center">
                            <span class="absolute -left-3 top-0 bottom-0 w-1 bg-red-600"></span>
                            Latest Episodes
                            <span class="ml-2 text-xs font-normal px-2 py-0.5 bg-red-600/20 text-red-400 rounded-sm">HOT</span>
                        </h2>
                        <a href="/recently-updated" class="text-sm text-gray-400 hover:text-red-500 transition-colors duration-300 flex items-center group">
                            View more 
                            <span class="transform translate-x-0 group-hover:translate-x-1 transition-transform duration-300 ml-1">→</span>
                        </a>
                    </div>
                    <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6">
                        {% for anime in latest_eps %}
                        {% include "animeCard.html" %}
                        {% endfor %}
                    </div>
                </section>


                <section class="mt-12">
                    <div class="mb-8 flex items-center justify-between">
                        <h2 class="text-xl sm:text-2xl font-bold text-white relative inline-flex items-center">
                            <span class="absolute -left-3 top-0 bottom-0 w-1 bg-red-600"></span>
                            New On Site
                            <span class="ml-2 text-xs font-normal px-2 py-0.5 bg-red-600/20 text-red-400 rounded-sm">HOT</span>
                        </h2>
                        <a href="/search?sort=Last%20Updated" class="text-sm text-gray-400 hover:text-red-500 transition-colors duration-300 flex items-center group">
                            View more 
                            <span class="transform translate-x-0 group-hover:translate-x-1 transition-transform duration-300 ml-1">→</span>
                        </a>
                    </div>
                    <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6">
                        {% for anime in last_updated %}
                        {% include "animeCard.html" %}
                        {% endfor %}
                    </div>
                </section>

                <section class="mt-12 rounded-lg bg-black p-4 sm:p-6 overflow-hidden" x-data="schedule()">
                    <!-- Loading Animation -->
                    <div x-show="isLoading" class="flex items-center justify-center h-64">
                        <div class="flex space-x-2">
                            <div class="loading-dot w-3 h-3 bg-theme-red rounded-full"></div>
                            <div class="loading-dot w-3 h-3 bg-theme-red rounded-full"></div>
                            <div class="loading-dot w-3 h-3 bg-theme-red rounded-full"></div>
                        </div>
                    </div>

                    <!-- Schedule Content -->
                    <div x-show="!isLoading">
                        <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-1">Estimated Schedule</h2>
                                <p class="text-sm text-gray-400"
                                    x-text="`${selectedDate} (${new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'long' })})`">
                                </p>
                            </div>
                        </div>
                        <div class="relative mb-6">
                            <div class="absolute left-0 top-1/2 -translate-y-1/2 z-10">
                                <button @click="scrollDates('left')"
                                    class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 19l-7-7 7-7" />
                                    </svg>
                                </button>
                            </div>
                            <div class="overflow-x-auto scrollbar-ass" x-ref="dateScroller">
                                <div class="inline-flex space-x-2 p-2">
                                    <template x-for="date in dates" :key="date">
                                        <button @click="setSelectedDate(date)" :class="{
                                                'bg-red-600 text-white': date === selectedDate,
                                                'bg-gray-800 text-gray-400 hover:bg-gray-700': date !== selectedDate
                                            }"
                                            class="flex-shrink-0 text-center py-2 px-4 rounded-lg text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 flex flex-col items-center justify-center w-16">
                                            <span x-text="new Date(date).toLocaleDateString('en-US', { weekday: 'short' })"
                                                class="block text-xs"></span>
                                            <span x-text="new Date(date).getDate()"
                                                class="block text-lg font-bold mt-1"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                            <div class="absolute right-0 top-1/2 -translate-y-1/2 z-10">
                                <button @click="scrollDates('right')"
                                    class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-4" x-data="{ hoveredItem: null }">
                            <template x-for="(item, index) in scheduleData[selectedDate]" :key="index">
                                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between rounded-sm bg-black p-4 transition-all duration-300 ease-in-out hover:bg-gray-900/50 border-b border-gray-700"
                                    @mouseenter="hoveredItem = index" @mouseleave="hoveredItem = null"
                                    :class="{ 'transform scale-[1.02]': hoveredItem === index }">
                                    <div class="flex items-start sm:items-center gap-4 mb-2 sm:mb-0">
                                        <div class="text-red-500 font-bold text-lg sm:text-base" x-text="item.time">
                                        </div>
                                        <div>
                                            <h3 class="font-medium text-white text-md sm:text-base" x-text="item.title">
                                            </h3>
                                            <p class="text-sm text-gray-400" x-text="`Episode ${item.episode}`"></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 mt-2 sm:mt-0">
                                        <span class="bg-red-500/20 text-red-500 text-xs px-2 py-1 rounded-full">New</span>
                                        <button
                                            class="bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-2 rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">
                                            Watch
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </section>
                <section class="mt-12">
                    <div class="mb-8 flex items-center justify-between">
                        <h2 class="text-xl sm:text-2xl font-bold text-white relative inline-flex items-center">
                            <span class="absolute -left-3 top-0 bottom-0 w-1 bg-red-600"></span>
                            Top Upcoming
                            <span class="ml-2 text-xs font-normal px-2 py-0.5 bg-red-600/20 text-red-400 rounded-sm">HOT</span>
                        </h2>
                        <a href="/upcoming" class="text-sm text-gray-400 hover:text-red-500 transition-colors duration-300 flex items-center group">
                            View more 
                            <span class="transform translate-x-0 group-hover:translate-x-1 transition-transform duration-300 ml-1">→</span>
                        </a>
                    </div>
                    <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6">
                        {% for anime in topUpcoming %}
                        {% include "animeCard.html" %}
                        {% endfor %}
                    </div>
                </section>
                {% if Surl %}
                <a href="{{ Surl }}" target="_blank" class="flex justify-center p-6">
                    <button id="redirect-button" class="px-6 py-2 bg-red-600 rounded-full">Open Link</button>
                </a>
                {% endif %}
            </section>
        </div>

        <!-- Sidebar (right side) - Now responsive -->
        <div class="lg:col-span-4 xl:col-span-3 space-y-6 hidden lg:block">
            <!-- Top 10 Section -->
            <section class="rounded-lg bg-gray-900/50 p-4">
                <div x-data="animeData()" x-init="init()" class="mx-auto">
                    <!-- Header -->
                    <div class="mb-6 flex items-center justify-between">
                        <h1 class="text-2xl font-bold text-white">Top 10</h1>
                        <div class="flex rounded-lg bg-gray-800/50 p-1">
                            <button class="rounded px-3 py-1.5 text-xs sm:text-sm font-semibold transition-colors duration-200"
                                :class="currentTab === 'today' ? 'bg-red-500 text-white' : 'text-gray-400 hover:bg-gray-700/50'"
                                @click="currentTab = 'today'; fetchAnimeData()">Today</button>
                            <button class="rounded px-3 py-1.5 text-xs sm:text-sm font-semibold transition-colors duration-200"
                                :class="currentTab === 'week' ? 'bg-red-500 text-white' : 'text-gray-400 hover:bg-gray-700/50'"
                                @click="currentTab = 'week'; fetchAnimeData()">Week</button>
                            <button class="rounded px-3 py-1.5 text-xs sm:text-sm font-semibold transition-colors duration-200"
                                :class="currentTab === 'month' ? 'bg-red-500 text-white' : 'text-gray-400 hover:bg-gray-700/50'"
                                @click="currentTab = 'month'; fetchAnimeData()">Month</button>
                        </div>
                    </div>

                    <!-- Loading Animation -->
                    <div x-show="isLoading" class="space-y-4">
                        <template x-for="i in 3">
                            <div class="glass-effect grid grid-cols-[48px_60px_1fr] items-start gap-4 rounded-xl p-4">
                                <!-- Ranking Number Skeleton -->
                                <div class="h-8 w-8 animate-pulse rounded bg-gray-700/50"></div>

                                <!-- Image Skeleton -->
                                <div class="h-[76px] w-[60px] animate-pulse rounded-lg bg-gray-700/50"></div>

                                <!-- Content Skeleton -->
                                <div class="flex flex-col justify-between h-[76px]">
                                    <div class="h-5 w-3/4 animate-pulse rounded bg-gray-700/50"></div>
                                    <div class="flex gap-2">
                                        <div class="h-4 w-12 animate-pulse rounded bg-gray-700/50"></div>
                                        <div class="h-4 w-12 animate-pulse rounded bg-gray-700/50"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Anime List -->
                    <div class="space-y-4" x-show="!isLoading">
                        <template x-for="(anime, index) in filteredAnime" :key="anime.title">
                            <div @click="window.location.href=anime.url"
                                class="glass-effect grid grid-cols-[48px_60px_1fr] items-start gap-4 rounded-xl p-4 cursor-pointer hover:bg-gray-800/50 transition-colors duration-200"
                                x-init="$nextTick(() => {
                                    anime({
                                        targets: $el,
                                        translateY: [20, 0],
                                        opacity: [0, 1],
                                        delay: index * 100,
                                        easing: 'easeOutExpo',
                                        duration: 800
                                    });
                                })">
                                <!-- Ranking Number -->
                                <span class="text-2xl font-bold text-gray-500"
                                    x-text="(index + 1).toString().padStart(2, '0')"></span>

                                <!-- Anime Image -->
                                <img :src="anime.image" :alt="anime.title"
                                    class="w-[60px] h-[76px] rounded-lg object-cover">

                                <!-- Anime Details -->
                                <div class="flex flex-col justify-between h-[76px] min-w-0" x-data>
                                    <h3 class="font-medium text-white leading-tight truncate" x-text="anime.title"></h3>
                                    <div class="flex flex-wrap gap-2">
                                        <!-- Keep Subbed & Dubbed in the same row -->
                                        <div class="flex items-center gap-2">
                                            <!-- Subbed Tag -->
                                            <span
                                                :class="`px-2 py-0.5 rounded text-xs font-bold bg-red-600 text-white flex items-center`">
                                                <i data-lucide="captions" class="w-3 h-3 mr-1"></i>
                                                <span x-text="anime.stats.subbed"></span>
                                            </span>

                                            <!-- Dubbed Tag with Lucide Icon -->
                                            <span
                                                :class="`px-2 py-0.5 rounded text-xs font-bold bg-blue-600 text-white flex items-center`">
                                                <i data-lucide="mic" class="w-3 h-3 mr-1"></i>
                                                <span x-text="anime.stats.dubbed"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Ensure Lucide icons re-render -->
                                <div x-effect="lucide.createIcons()"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </section>

            <!-- Download Banner -->
            <div class="mt-6">
                {% include "downloadBanner.html" %}
            </div>

            <section class="mt-6 rounded-lg bg-gray-900/50 p-4 hidden">
                <h3 class="mb-4 text-sm font-semibold uppercase text-red-500 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                    TOP COMMENTS
                </h3>
                <div class="space-y-3">
                    <template x-for="comment in $store.animeData.topComments" :key="comment.user">
                        <div class="text-sm">
                            <p class="font-semibold" x-text="comment.user"></p>
                            <p class="text-gray-400" x-text="comment.comment"></p>
                            <p class="text-xs text-gray-500" x-text="`${comment.likes} likes`"></p>
                        </div>
                    </template>
                </div>
            </section>

            <!-- Trending Posts Section -->
            <section class="rounded-lg bg-gray-900/50 p-4 backdrop-blur-sm">
                <div x-data="trendingPosts()" x-init="init()" class="container mx-auto">
                    <header class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-pink-300">Trending Posts</h1>
                        <button @click="window.location.href='/community'"
                            class="text-gray-400 hover:text-gray-200 transition-colors duration-300 flex items-center gap-1">
                            View more
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </button>
                    </header>

                    <div class="space-y-4">
                        <template x-for="(post, index) in posts" :key="index">
                            <article class="glass rounded-lg p-4 transition-all duration-300 hover:bg-gray-700/30 cursor-pointer"
                                x-init="
                                    anime({
                                        targets: $el,
                                        translateY: [20, 0],
                                        opacity: [0, 1],
                                        delay: index * 100,
                                        easing: 'easeOutElastic(1, .8)',
                                        duration: 800
                                    })
                                ">
                                <a x-bind:href="post.link" class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-blue-400 text-sm" x-text="'#' + post.tag"></span>
                                        <span class="text-gray-500">•</span>
                                        <span class="text-gray-400 text-sm" x-text="post.time"></span>
                                    </div>
                                    <div class="flex items-center gap-1 text-gray-400">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                                            </path>
                                        </svg>
                                        <span class="text-sm" x-text="post.comments"></span>
                                    </div>
                                </a>
                                <h2 class="text-white font-semibold mb-2" x-text="post.title"></h2>
                                <p class="text-gray-400 text-sm mb-4 line-clamp-2" x-text="post.content"></p>
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500">
                                        <img :src="post.authorAvatar" alt="Avatar"
                                            class="w-8 h-8 rounded-full border-0 border-[#DC143C] animate-pulse-slow">
                                    </div>
                                    <span class="text-white text-sm" x-text="post.author"></span>
                                    <template x-if="post.badge">
                                        <span class="px-2 py-0.5 rounded text-xs bg-gray-700 text-gray-300"
                                            x-text="post.badge"></span>
                                    </template>
                                </div>
                            </article>
                        </template>
                    </div>
                </div>
            </section>
            <script>
                function trendingPosts() {
                    return {
                        posts: [],
                        async init() {
                            try {
                                const response = await fetch('/api/top/posts');
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                const data = await response.json();
                                this.posts = data.posts; // Assuming the API returns { posts: [...] }
                            } catch (error) {
                                console.error('Error fetching posts:', error);
                                this.posts = []; // Fallback to an empty array
                            }
                        }
                    }
                }
            </script>
        </div>
    </div>
</main>

{% include "Changelog.html" %}
<div x-data="counter()" x-init="setupSocket()" @join-room.window="joinRoom()"
    class="float-counter hidden fixed bottom-8 right-8 rounded-full p-4 text-white flex items-center gap-2 z-50 cursor-pointer hover:scale-105 transition-transform duration-300"
    @mouseover="pulse()">

    <!-- Loading Animation (visible when isLoading is true) -->
    <svg x-cloak x-show="isLoading" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
        fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
        </path>
    </svg>

    <!-- Counter Display -->
    <div x-cloak x-show="!isLoading" class="relative overflow-hidden h-8">
        <span x-text="formatCount(totalCount)" class="number-animation inline-block text-xl font-bold"
            :class="{'number-up': increasing, 'number-down': decreasing}"></span>
    </div>
    <div class="w-2 h-2 rounded-full bg-red-500 animate-ping"></div>
</div>
{% include "footer.html" %}
<!-- ... (keep existing scripts) ... -->
<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
<script>
    lucide.createIcons();
</script>

<script>
    // Alpine.js data and functions
    document.addEventListener('alpine:init', () => {
        Alpine.data('footerAnimation', () => ({
            init() {
                anime({
                    targets: this.$el.querySelectorAll('img, p'),
                    translateY: [20, 0],
                    opacity: [0, 1],
                    delay: anime.stagger(100),
                    easing: 'easeOutExpo',
                    duration: 1000
                });
            }
        }));
        Alpine.store('animeData', {
            isDesktop: window.innerWidth >= 768,

        });

        window.addEventListener('resize', () => {
            Alpine.store('animeData').isDesktop = window.innerWidth >= 768;
        });

        Alpine.data('schedule', () => ({
            selectedDate: '',
            dates: [],
            scheduleData: {},
            isLoading: true,
            async fetchData() {
                this.isLoading = true; // Show the loader while fetching data
                try {
                    // Get the user's timezone from their browser
                    const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                    // Make the API request with the timezone as a query parameter
                    const response = await fetch(`/api/schedule?timezone=${encodeURIComponent(userTimeZone)}`);
                    const data = await response.json();

                    // Process the response
                    this.dates = Object.keys(data);
                    this.scheduleData = data;
                    this.selectedDate = this.dates[0]; // Set the first date as selected by default
                } catch (error) {
                    console.error('Error fetching schedule:', error);
                } finally {
                    this.isLoading = false; // Hide the loader once data is fetched
                }
            },
            setSelectedDate(date) {
                this.selectedDate = date;
            },
            scrollDates(direction) {
                const scroller = this.$refs.dateScroller;
                const scrollAmount = scroller.offsetWidth * 0.8;
                if (direction === 'left') {
                    scroller.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
                } else {
                    scroller.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                }
            },
            init() {
                this.fetchData();
            }
        }));
    });

    // Swiper initialization
    document.addEventListener('DOMContentLoaded', function () {
        new Swiper('.swiper-container', {
            loop: true,
            navigation: {
                nextEl: '.next',
                prevEl: '.prev',
            },
            autoplay: {
                delay: 5000,
            },
            pagination: {
                el: ".swiper-pagination",
                dynamicBullets: true,
            },
        });
        const swiper = new Swiper('.anime_watchlist_swiper_7391', {
            slidesPerView: 2,
            spaceBetween: 16,
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
            breakpoints: {
                640: {
                    slidesPerView: 2,
                },
                768: {
                    slidesPerView: 3,
                },
                1024: {
                    slidesPerView: 4,
                },
                1280: {
                    slidesPerView: 4,
                }
            }
        });
        const downloadBanner = document.querySelector('.kuudere-download-banner');
            if (downloadBanner) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // Animate the banner
                            anime({
                                targets: '.kuudere-download-banner',
                                opacity: [0, 1],
                                translateY: [20, 0],
                                duration: 800,
                                easing: 'easeOutExpo'
                            });

                            // Animate the device icons with delay
                            anime({
                                targets: '.kuudere-device-icon',
                                opacity: [0, 1],
                                translateY: [10, 0],
                                delay: anime.stagger(100, { start: 300 }),
                                duration: 600,
                                easing: 'easeOutQuad'
                            });

                            // Unobserve after animation
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.2 });

                observer.observe(downloadBanner);
            }
    });

    // Anime.js animation for card hover
    document.addEventListener('alpine:initialized', () => {
        const cards = document.querySelectorAll('.anime-card');
        cards.forEach(card => {
            card.addEventListener('mouseenter', () => {
                anime({
                    targets: card,
                    scale: 1.05,
                    duration: 300,
                    easing: 'easeOutQuad'
                });
            });
            card.addEventListener('mouseleave', () => {
                anime({
                    targets: card,
                    scale: 1,
                    duration: 300,
                    easing: 'easeOutQuad'
                });
            });
        });
    });

    // Anime.js animation for schedule items
    document.addEventListener('alpine:initialized', () => {
        const scheduleItems = document.querySelectorAll('.space-y-4 > div');
        scheduleItems.forEach((item, index) => {
            anime({
                targets: item,
                opacity: [0, 1],
                translateY: [20, 0],
                delay: index * 100,
                duration: 500,
                easing: 'easeOutQuad'
            });
        });
    });
    function watch(id) {
        window.location.href = `/watch/${id}`;
    }

    function counter() {
        return {
            totalCount: 0,
            increasing: false,
            decreasing: false,
            socket: null,
            currentRoom: null,
            isConnected: false,
            isLoading: true,  // New property to track loading state

            setupSocket() {
                this.socket = io({ transports: ['websocket'] });

                this.socket.on('connect', () => {
                    this.isConnected = true;
                    console.log('Connected to server');
                    this.socket.emit('get_all_counts');
                    this.joinRoom(); // Automatically join the "home" room after connecting
                });

                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                });

                this.setupSocketListeners();
            },

            setupSocketListeners() {
                this.socket.on('all_room_counts', (data) => {
                    const previousTotalCount = this.totalCount;
                    this.totalCount = Object.values(data).reduce((total, count) => total + count, 0);

                    // Hide loading animation once data is synced
                    this.isLoading = false;

                    // Call animateCountChange based on whether the count increased or decreased
                    if (this.totalCount > previousTotalCount) {
                        this.animateCountChange('up');
                    } else if (this.totalCount < previousTotalCount) {
                        this.animateCountChange('down');
                    }
                });

                setInterval(() => {
                    if (this.isConnected) {
                        this.socket.emit('get_all_counts');
                    }
                }, 10000);
            },

            joinRoom() {
                if (this.currentRoom) {
                    this.socket.emit('leave', { room: this.currentRoom });
                }
                const data = { other_id: 'home' };
                this.socket.emit('join', data);
                this.currentRoom = "home";
            },

            formatCount(num) {
                return num > 999 ? (num / 1000).toFixed(1) + 'k' : num;
            },

            animateCountChange(direction) {
                if (direction === 'up') {
                    this.increasing = true;
                    this.decreasing = false;
                } else {
                    this.increasing = false;
                    this.decreasing = true;
                }

                setTimeout(() => {
                    this.increasing = false;
                    this.decreasing = false;
                }, 300);
            },

            pulse() {
                anime({
                    targets: '.float-counter',
                    scale: [1, 1.1],
                    duration: 300,
                    easing: 'easeInOutQuad',
                    direction: 'alternate'
                });
            }
        }
    }
    function animeData() {
        return {
            currentTab: 'today',
            animeList: {},
            isLoading: true,

            async init() {
                await this.fetchAnimeData();
            },

            async fetchAnimeData() {
                this.isLoading = true;
                try {
                    const response = await fetch(`/api/top/anime/?tab=${this.currentTab}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    this.animeList = {
                        ...this.animeList,
                        [this.currentTab]: data
                    };
                } catch (error) {
                    console.error('Error fetching anime data:', error);
                    this.animeList[this.currentTab] = [];
                } finally {
                    this.isLoading = false;
                }
            },

            get filteredAnime() {
                return this.animeList[this.currentTab] || [];
            }
        }
    }
</script>
<script>
    function triggerJoinRoom() {
        window.dispatchEvent(new Event('join-room'));
    }
</script>
{% endblock %}